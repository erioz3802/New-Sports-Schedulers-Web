# utils/chatbot_susan.py - Enhanced with Detailed Step-by-Step Instructions

import re
import random
from datetime import datetime

class ChatbotSusan:
    """Enhanced conversational chatbot with detailed step-by-step instructions"""
    
    def __init__(self):
        self.name = "Susan"
        self.version = "2.1 - Detailed Instructions"
        
        # Enhanced context keywords for more specific detection
        self.context_keywords = {
            'greeting': ['hi', 'hello', 'hey', 'greetings', 'good morning', 'good afternoon', 'good evening', 'susan'],
            'thanks': ['thank', 'thanks', 'appreciate', 'grateful', 'thx'],
            'help': ['help', 'assistance', 'support', 'guide', 'how to', 'tutorial'],
            
            # Specific action keywords for detailed instructions
            'add_user': ['add user', 'create user', 'new user', 'add official', 'create official', 'new official'],
            'add_game': ['add game', 'create game', 'new game', 'schedule game'],
            'assign_officials': ['assign official', 'assign officials', 'assign ref', 'assign referee'],
            'add_league': ['add league', 'create league', 'new league'],
            'add_location': ['add location', 'create location', 'new location', 'add venue'],
            'view_reports': ['view reports', 'see reports', 'show reports', 'reports'],
            'set_availability': ['set availability', 'availability', 'set schedule', 'block time'],
            'view_assignments': ['my assignments', 'view assignments', 'see assignments', 'show assignments'],
            
            # General categories
            'users': ['user', 'users', 'people', 'person', 'account', 'accounts'],
            'games': ['game', 'games', 'schedule', 'scheduling', 'match', 'matches'],
            'assignments': ['assign', 'assignment', 'assignments', 'assigned'],
            'leagues': ['league', 'leagues', 'competition', 'tournament'],
            'locations': ['location', 'locations', 'venue', 'venues', 'field', 'fields'],
            'reports': ['report', 'reports', 'earnings', 'financial', 'statistics', 'stats'],
            'navigation': ['navigate', 'navigation', 'find', 'where', 'how to get to', 'menu'],
            'errors': ['error', 'problem', 'issue', 'bug', 'not working', 'broken', 'trouble'],
            'login': ['login', 'log in', 'sign in', 'password', 'authentication']
        }
        
        # Detailed step-by-step instructions
        self.detailed_instructions = {
            'add_user': {
                'superadmin': """**üìã Step-by-Step: Add a New User**

**Step 1:** Click **"Users"** in the main navigation menu
**Step 2:** Click the **"Add User"** button (usually blue, top-right)
**Step 3:** Fill out the user form:
   ‚Ä¢ **First Name:** Enter their first name
   ‚Ä¢ **Last Name:** Enter their last name  
   ‚Ä¢ **Email:** Must be unique (this is their login)
   ‚Ä¢ **Password:** Create a temporary password
   ‚Ä¢ **Role:** Choose from dropdown (Official, Assigner, Administrator, etc.)
   ‚Ä¢ **Phone:** Optional but recommended
**Step 4:** Click **"Save"** or **"Add User"**
**Step 5:** The new user will appear in your user list

üí° **Pro Tip:** The user can change their password after first login.

Need help with any specific step? ü§î""",
                
                'administrator': """**üìã Step-by-Step: Add a New User**

**Step 1:** Go to **Admin** ‚Üí **"Manage Users"**
**Step 2:** Click **"Add New User"** button
**Step 3:** Complete the registration form:
   ‚Ä¢ **Email Address:** This becomes their username
   ‚Ä¢ **First & Last Name:** Full name for identification
   ‚Ä¢ **Role:** Select appropriate role (Official is most common)
   ‚Ä¢ **Phone Number:** For communications
   ‚Ä¢ **Initial Password:** They can change this later
**Step 4:** Select which **leagues** they should have access to
**Step 5:** Click **"Create User"**

‚úÖ **Result:** User receives account and can log in immediately.

Having trouble with any step? Let me know! üìû"""
            },
            
            'add_game': {
                'administrator': """**üìã Step-by-Step: Create a New Game**

**Step 1:** Navigate to **"Games"** in the main menu
**Step 2:** Click **"Add Game"** (green button)
**Step 3:** Select game details:
   ‚Ä¢ **League:** Choose from dropdown
   ‚Ä¢ **Date:** Click calendar picker
   ‚Ä¢ **Time:** Use time selector
   ‚Ä¢ **Location:** Select venue from list
   ‚Ä¢ **Field:** Choose specific field if multiple available
**Step 4:** Enter game information:
   ‚Ä¢ **Home Team:** Team name
   ‚Ä¢ **Away Team:** Team name  
   ‚Ä¢ **Game Level:** Select appropriate level
   ‚Ä¢ **Notes:** Any special instructions (optional)
**Step 5:** Set **Game Status:**
   ‚Ä¢ **Draft:** For editing later
   ‚Ä¢ **Ready:** For review
   ‚Ä¢ **Released:** Officials can see and accept
**Step 6:** Click **"Save Game"**

üéØ **Next Step:** Assign officials to the game!

Need help with officials assignment? ü§ù""",
                
                'assigner': """**üìã Step-by-Step: Schedule a Game**

**Step 1:** Click **"Games"** ‚Üí **"Add New Game"**
**Step 2:** Choose your **League** (you can only see your assigned leagues)
**Step 3:** Set the **Date & Time:**
   ‚Ä¢ Use the date picker for accurate dates
   ‚Ä¢ Set start time (system calculates end time)
**Step 4:** Pick **Location & Field:**
   ‚Ä¢ Select from available venues
   ‚Ä¢ Choose specific field if location has multiple
   ‚Ä¢ System checks for conflicts automatically
**Step 5:** Enter **Team Details:**
   ‚Ä¢ Home team name
   ‚Ä¢ Visiting team name
   ‚Ä¢ Competition level
**Step 6:** **Save as Draft** first to review
**Step 7:** When ready, **change status to "Released"**

‚ö° **Quick Tip:** You can clone similar games to save time!

Ready to assign officials to this game? üë•"""
            },
            
            'assign_officials': {
                'administrator': """**üìã Step-by-Step: Assign Officials to a Game**

**Step 1:** Go to **Games** ‚Üí **"Manage Games"**
**Step 2:** Find your game and click **"Assign Officials"**
**Step 3:** Choose assignment method:

**üéØ Manual Assignment:**
   ‚Ä¢ Click **"Manual Assignment"**
   ‚Ä¢ Select officials from the dropdown
   ‚Ä¢ System shows their availability status
   ‚Ä¢ Add multiple officials as needed
   
**ü§ñ Auto-Assignment:**
   ‚Ä¢ Click **"Auto-Assignment"** 
   ‚Ä¢ System picks best officials based on:
     - Availability (no conflicts)
     - Rankings (1-5 scale)
     - Workload balance
   ‚Ä¢ Review suggestions before confirming

**Step 4:** **Release the game** so officials can see it
**Step 5:** Officials will get notified and can accept/decline

üîç **Check Status:** View assignment responses in the game details.

Want help with the ranking system? ‚≠ê"""
            },
            
            'add_league': {
                'administrator': """**üìã Step-by-Step: Create a New League**

**Step 1:** Navigate to **"Leagues"** in main menu
**Step 2:** Click **"Add League"** button
**Step 3:** Enter **Basic Information:**
   ‚Ä¢ **League Name:** Clear, descriptive name
   ‚Ä¢ **Sport:** Basketball, Soccer, etc.
   ‚Ä¢ **Season:** Fall 2024, Spring 2025, etc.
   ‚Ä¢ **Level:** High School, Youth, Adult, etc.
**Step 4:** Set **Financial Details:**
   ‚Ä¢ **Game Fee:** How much officials earn per game
   ‚Ä¢ **Payment Schedule:** When officials get paid
   ‚Ä¢ **Billing Contact:** Who handles payments
**Step 5:** Configure **Settings:**
   ‚Ä¢ **Game Duration:** Standard game length
   ‚Ä¢ **Officials Needed:** How many per game
   ‚Ä¢ **Assignment Rules:** Auto vs manual
**Step 6:** Click **"Create League"**
**Step 7:** **Add Officials** to the league roster

‚ú® **Next Steps:** Add locations and start scheduling games!

Need help adding officials to your new league? üë•"""
            },
            
            'view_assignments': {
                'official': """**üìã Step-by-Step: View Your Assignments**

**Step 1:** Login to your account
**Step 2:** Your **Dashboard** shows upcoming assignments immediately
**Step 3:** For detailed view, click **"My Assignments"** or **"Assignments"**
**Step 4:** You'll see:
   ‚Ä¢ **Upcoming Games:** Next 7 days highlighted
   ‚Ä¢ **Game Details:** Date, time, location, teams
   ‚Ä¢ **Partner Officials:** Who you're working with
   ‚Ä¢ **Game Status:** Confirmed, pending, etc.
   ‚Ä¢ **Payment Info:** Your earnings per game

**üì± Game Details Include:**
   ‚Ä¢ Full address with map link
   ‚Ä¢ Partner contact information
   ‚Ä¢ Special game notes
   ‚Ä¢ Weather alerts (if applicable)

**Step 5:** Click any game for **full details** and **directions**

üìÖ **Pro Tip:** Use the calendar view to see your whole schedule at once!

Need help with accepting/declining assignments? ‚úÖ‚ùå"""
            },
            
            'view_reports': {
                'administrator': """**üìã Step-by-Step: Access Reports**

**Step 1:** Click **"Reports"** in the main navigation
**Step 2:** Choose your report type:

**üí∞ Financial Reports:**
   ‚Ä¢ **Official Payments:** Who earned what
   ‚Ä¢ **League Expenses:** Total costs per league
   ‚Ä¢ **Payment Status:** Pending vs. paid

**üìä Assignment Reports:**
   ‚Ä¢ **Official Workload:** Games per official
   ‚Ä¢ **Assignment Response Rates:** Accept/decline stats
   ‚Ä¢ **Conflict Reports:** Scheduling issues

**üìà Performance Analytics:**
   ‚Ä¢ **League Statistics:** Games scheduled vs. completed
   ‚Ä¢ **Official Rankings:** Performance metrics
   ‚Ä¢ **Utilization Reports:** How efficiently officials are used

**Step 3:** **Filter** by date range, league, or official
**Step 4:** **Export** to Excel/CSV for external analysis
**Step 5:** **Print** or **Email** reports as needed

üéØ **Quick Access:** Bookmark frequently used reports!

Which specific report do you need help with? üìã"""
            }
        }
    
    def process_message(self, message, user_context=None):
        """Process user message and return detailed, actionable response"""
        if not message or not message.strip():
            return self._get_greeting_response(user_context)
            
        message_lower = message.lower().strip()
        
        # Get user role for personalization
        user_role = user_context.get('role', 'user') if user_context else 'user'
        user_name = user_context.get('first_name', 'friend') if user_context else 'friend'
        
        # Check for specific action requests first (highest priority)
        for action, keywords in self.context_keywords.items():
            if action.startswith('add_') or action.startswith('view_') or action.startswith('set_'):
                if any(keyword in message_lower for keyword in keywords):
                    return self._get_detailed_instruction(action, user_role, user_name)
        
        # Then check for general categories
        primary_context = self._detect_primary_context(message_lower)
        
        # Generate appropriate response
        if primary_context == 'greeting':
            return self._get_greeting_response(user_context)
        elif primary_context == 'thanks':
            return self._get_thanks_response()
        elif primary_context == 'help':
            return self._get_help_response(user_role)
        elif primary_context in ['users', 'games', 'assignments', 'leagues', 'locations', 'reports']:
            return self._get_category_help(primary_context, user_role, user_name)
        else:
            return self._get_default_response(user_name, user_role)
    
    def _detect_primary_context(self, message):
        """Detect the primary context/intent of the message"""
        # Check each context category
        for context, keywords in self.context_keywords.items():
            if any(keyword in message for keyword in keywords):
                return context
        return None
    
    def _get_detailed_instruction(self, action, user_role, user_name):
        """Get detailed step-by-step instructions for specific actions"""
        if action in self.detailed_instructions:
            instructions = self.detailed_instructions[action]
            if isinstance(instructions, dict):
                # Role-specific instructions
                return instructions.get(user_role, instructions.get('default', 
                    f"I can help you with {action.replace('_', ' ')}, but I need to provide role-specific instructions. What's your role in the system?"))
            else:
                return instructions
        
        # Fallback for actions not yet detailed
        action_name = action.replace('_', ' ').title()
        return f"""**{action_name} Instructions** üìã

I'd love to give you step-by-step instructions for {action_name}, {user_name}! 

To provide the most accurate steps, could you tell me:
‚Ä¢ What specific part are you stuck on?
‚Ä¢ Have you started the process already?
‚Ä¢ Are you seeing any error messages?

This helps me give you exactly the right guidance! üéØ"""
    
    def _get_category_help(self, category, user_role, user_name):
        """Get help for general categories with specific action prompts"""
        category_help = {
            'users': f"""**User Management Help** üë•

Hi {user_name}! I can give you detailed instructions for:

üîß **Specific Actions:**
‚Ä¢ **"add user"** ‚Üí Step-by-step user creation
‚Ä¢ **"edit user profile"** ‚Üí Modify user details  
‚Ä¢ **"change user role"** ‚Üí Update permissions
‚Ä¢ **"reset password"** ‚Üí Help users with login issues

üí° **Just say:** "add user" or "how to add user" for detailed steps!

What specific user task do you need help with? ü§î""",
            
            'games': f"""**Game Management Help** üéÆ

Ready to help you with games, {user_name}!

üéØ **Specific Instructions Available:**
‚Ä¢ **"add game"** ‚Üí Complete game creation walkthrough
‚Ä¢ **"assign officials"** ‚Üí Step-by-step official assignment
‚Ä¢ **"clone game"** ‚Üí Copy existing games quickly
‚Ä¢ **"change game status"** ‚Üí Update Draft‚ÜíReady‚ÜíReleased

üìã **Just ask:** "how to add game" for detailed steps!

What game management task can I walk you through? ‚öΩ"""
        }
        
        return category_help.get(category, f"I can help you with {category}, {user_name}! What specific task do you need step-by-step instructions for?")
    
    def _get_greeting_response(self, user_context):
        """Get personalized greeting based on user role"""
        user_role = user_context.get('role', 'default') if user_context else 'default'
        user_name = user_context.get('first_name', 'friend') if user_context else 'friend'
        
        role_greetings = {
            'superadmin': f"Hi {user_name}! üëã I'm Susan, your Sports Scheduler assistant. As the superadmin, you have access to everything! I can give you detailed step-by-step instructions for any task. What would you like to do?",
            'administrator': f"Hello {user_name}! üòä I'm Susan. As an admin, I can walk you through user management, league creation, game scheduling, and more. What task needs step-by-step instructions?",
            'assigner': f"Hey {user_name}! I'm Susan. Ready to help you with detailed game management and official assignment instructions. What do you need help with?",
            'official': f"Hi {user_name}! üëã I'm Susan. I can guide you through viewing assignments, setting availability, and more. What do you need step-by-step help with?",
            'viewer': f"Hello {user_name}! I'm Susan. I can help you find and understand reports and league information. What do you need detailed help with?",
            'default': f"Hi {user_name}! üëã I'm Susan, your Sports Scheduler assistant. I can provide detailed, step-by-step instructions for any task. What do you need help with?"
        }
        
        return role_greetings.get(user_role, role_greetings['default'])
    
    def _get_thanks_response(self):
        """Return a friendly thanks response"""
        responses = [
            "You're so welcome! Happy to help with detailed instructions anytime! üòä",
            "No problem at all! I love walking people through things step-by-step!",
            "Glad I could help! Feel free to ask for detailed help with anything else.",
            "You're very welcome! I'm here whenever you need step-by-step guidance! üåü"
        ]
        return random.choice(responses)
    
    def _get_help_response(self, user_role):
        """Get role-specific help response"""
        help_responses = {
            'superadmin': """**Superadmin Detailed Help** üéØ

I can provide step-by-step instructions for:

üë• **User Management:**
‚Ä¢ "add user" ‚Üí Complete user creation walkthrough
‚Ä¢ "manage roles" ‚Üí Role assignment instructions
‚Ä¢ "bulk user import" ‚Üí Import multiple users

üèÜ **League Management:**  
‚Ä¢ "add league" ‚Üí Detailed league creation
‚Ä¢ "league settings" ‚Üí Configuration instructions

üéÆ **Game Management:**
‚Ä¢ "add game" ‚Üí Game creation walkthrough  
‚Ä¢ "assign officials" ‚Üí Assignment instructions

üìä **Reports & Analytics:**
‚Ä¢ "view reports" ‚Üí Report access instructions
‚Ä¢ "export data" ‚Üí Data export steps

**Just ask for what you need!** For example: "add user" or "how to create a league"

What specific task needs detailed instructions? ü§î""",
            
            'administrator': """**Administrator Step-by-Step Help** üéØ

I specialize in detailed instructions for:

üë• **User Management:**
‚Ä¢ "add user" ‚Üí Complete user creation process
‚Ä¢ "edit user" ‚Üí Profile modification steps
‚Ä¢ "user permissions" ‚Üí Role management

üèÜ **League Operations:**
‚Ä¢ "add league" ‚Üí League creation walkthrough
‚Ä¢ "manage leagues" ‚Üí League administration

üéÆ **Game Scheduling:**
‚Ä¢ "add game" ‚Üí Game creation instructions
‚Ä¢ "assign officials" ‚Üí Assignment process

üìä **Reporting:**
‚Ä¢ "view reports" ‚Üí Report access and interpretation

**üí° Pro Tip:** Be specific! Say "add user" instead of just "users" for step-by-step instructions.

What task do you need detailed help with? üìã"""
        }
        
        return help_responses.get(user_role, """**General Help** üéØ

I can provide detailed, step-by-step instructions for most tasks!

**üí° For best results, be specific:**
‚Ä¢ Say "add user" instead of "users"  
‚Ä¢ Say "create game" instead of "games"
‚Ä¢ Say "view reports" instead of "reports"

**Popular requests:**
‚Ä¢ "add user" ‚Üí User creation walkthrough
‚Ä¢ "add game" ‚Üí Game scheduling instructions  
‚Ä¢ "assign officials" ‚Üí Assignment process
‚Ä¢ "view assignments" ‚Üí How to check your schedule

What specific task needs step-by-step instructions? ü§î""")
    
    def _get_default_response(self, user_name, user_role):
        """Friendly fallback response"""
        return f"""I'd love to help you with detailed instructions, {user_name}! üòä

**üí° For step-by-step help, try being specific:**
‚Ä¢ **"add user"** ‚Üí Complete user creation walkthrough
‚Ä¢ **"add game"** ‚Üí Game scheduling instructions
‚Ä¢ **"assign officials"** ‚Üí Official assignment process  
‚Ä¢ **"view reports"** ‚Üí Report access guide
‚Ä¢ **"view assignments"** ‚Üí Check your schedule

**Or tell me what you're trying to do:**
‚Ä¢ "I need to schedule a game"
‚Ä¢ "I want to add a new official"
‚Ä¢ "How do I check my assignments"

What specific task can I walk you through step-by-step? üìã"""
    
    def generate_suggestions(self, message, user_context):
        """Generate smart suggestions based on context"""
        user_role = user_context.get('role', 'user') if user_context else 'user'
        
        # Role-specific suggestions with actionable phrases
        role_suggestions = {
            'superadmin': [
                'add user',
                'add league', 
                'view reports',
                'assign officials'
            ],
            'administrator': [
                'add user',
                'add game',
                'add league',
                'view reports'
            ],
            'assigner': [
                'add game',
                'assign officials',
                'view assignments',
                'check schedules'
            ],
            'official': [
                'view assignments',
                'set availability',
                'view earnings',
                'contact partners'
            ],
            'viewer': [
                'view reports',
                'check schedules',
                'league information',
                'game statistics'
            ]
        }
        
        suggestions = role_suggestions.get(user_role, ['add user', 'add game', 'view reports', 'help'])
        
        # Context-based suggestions
        if message:
            message_lower = message.lower()
            if 'user' in message_lower:
                suggestions = ['add user', 'edit user', 'user permissions', 'reset password']
            elif 'game' in message_lower:
                suggestions = ['add game', 'assign officials', 'clone game', 'change game status']
            elif 'report' in message_lower:
                suggestions = ['view reports', 'financial reports', 'export data', 'assignment stats']
        
        return suggestions[:4]  # Limit to 4 suggestions

# For backward compatibility with existing simple responses
ENHANCED_RESPONSES = {
    'hello': "Hi! üëã I'm Susan, your Sports Scheduler assistant. I can provide detailed step-by-step instructions for any task. What do you need help with?",
    'help': """I can provide detailed step-by-step instructions for:
‚Ä¢ **"add user"** ‚Üí Complete user creation walkthrough
‚Ä¢ **"add game"** ‚Üí Game scheduling instructions
‚Ä¢ **"assign officials"** ‚Üí Official assignment process
‚Ä¢ **"view reports"** ‚Üí Report access guide

What specific task needs detailed instructions?""",
    'default': "I'm here to provide detailed step-by-step instructions! What specific task can I walk you through?"
}