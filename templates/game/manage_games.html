{% extends "base.html" %}

{% block title %}Manage Games - Sports Scheduler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-calendar-event me-2"></i>Manage Games</h1>
            <a href="{{ url_for('game.add_game') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>Add New Game
            </a>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search }}" placeholder="Team names, location...">
                    </div>
                    <div class="col-md-2">
                        <label for="league" class="form-label">League</label>
                        <select class="form-select" id="league" name="league">
                            <option value="">All Leagues</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}" {{ 'selected' if league_filter == league.id|string }}>
                                {{ league.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Status</option>
                            <option value="draft" {{ 'selected' if status_filter == 'draft' }}>Draft</option>
                            <option value="ready" {{ 'selected' if status_filter == 'ready' }}>Ready</option>
                            <option value="released" {{ 'selected' if status_filter == 'released' }}>Released</option>
                            <option value="completed" {{ 'selected' if status_filter == 'completed' }}>Completed</option>
                            <option value="cancelled" {{ 'selected' if status_filter == 'cancelled' }}>Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date" value="{{ date_filter }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-search me-1"></i>Filter
                            </button>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <a href="{{ url_for('game.manage_games') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-lg"></i>
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Games Table -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                {% if games.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Game Details</th>
                                <th>Date & Time</th>
                                <th>Location</th>
                                <th>League</th>
                                <th>Status</th>
                                <th>Officials</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in games.items %}
                            <tr class="{{ 'table-light' if game.status == 'completed' else 'table-warning' if game.status == 'draft' }}">
                                <td>
                                    <strong>{{ game.game_title }}</strong>
                                    {% if game.level %}
                                    <br><span class="badge bg-info">{{ game.level }}</span>
                                    {% endif %}
                                    {% if game.fee_per_official %}
                                    <br><small class="text-success">${{ "%.2f"|format(game.fee_per_official) }} per official</small>
                                    {% endif %}
                                    {% if game.notes %}
                                    <br><small class="text-muted">{{ game.notes[:50] }}{% if game.notes|length > 50 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ game.date.strftime('%m/%d/%Y') }}</strong>
                                    <br>{{ game.time.strftime('%I:%M %p') }}
                                    {% if game.estimated_duration != 120 %}
                                    <br><small class="text-muted">{{ game.estimated_duration }} min</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ game.location.name }}</strong>
                                    {% if game.field_name %}
                                    <br><small class="text-info">{{ game.field_name }}</small>
                                    {% endif %}
                                    {% if game.location.city %}
                                    <br><small class="text-muted">{{ game.location.city }}, {{ game.location.state }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ game.league.name }}</strong>
                                    <br><small class="text-muted">{{ game.league.level }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'secondary' if game.status == 'draft' else 'warning' if game.status == 'ready' else 'info' if game.status == 'released' else 'success' if game.status == 'completed' else 'danger' }}">
                                        {{ game.status.title() }}
                                    </span>
                                    {% if game.released_at and game.status == 'released' %}
                                    <br><small class="text-muted">Released {{ game.released_at.strftime('%m/%d/%y') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ game.assigned_officials_count }}</strong> assigned
                                    {% if game.assigned_officials_count == 0 and game.status == 'released' %}
                                    <br><span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Unassigned</span>
                                    {% elif game.assigned_officials_count > 0 %}
                                    <br><a href="{{ url_for('game.assign_officials', game_id=game.id) }}" class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-people"></i> View
                                    </a>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <!-- Edit Button -->
                                        {% if game.can_be_edited %}
                                        <a href="{{ url_for('game.edit_game', game_id=game.id) }}" 
                                           class="btn btn-outline-primary" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% else %}
                                        <button class="btn btn-outline-secondary" disabled title="Cannot edit past or completed games">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <!-- Assign Officials Button -->
                                        <a href="{{ url_for('game.assign_officials', game_id=game.id) }}" 
                                           class="btn btn-outline-success" title="Assign Officials">
                                            <i class="bi bi-person-plus"></i>
                                        </a>
                                        
                                        <!-- Status Change Dropdown -->
                                        <div class="btn-group">
                                            <button class="btn btn-outline-warning dropdown-toggle" 
                                                    data-bs-toggle="dropdown" title="Change Status">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                {% if game.status == 'draft' %}
                                                <li>
                                                    <form method="POST" action="{{ url_for('game.change_game_status', game_id=game.id) }}" class="d-inline">
                                                        <input type="hidden" name="status" value="ready">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="bi bi-check-circle me-2"></i>Mark as Ready
                                                        </button>
                                                    </form>
                                                </li>
                                                {% endif %}
                                                
                                                {% if game.status == 'ready' %}
                                                <li>
                                                    <form method="POST" action="{{ url_for('game.change_game_status', game_id=game.id) }}" class="d-inline">
                                                        <input type="hidden" name="status" value="released">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="bi bi-broadcast me-2"></i>Release Game
                                                        </button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <form method="POST" action="{{ url_for('game.change_game_status', game_id=game.id) }}" class="d-inline">
                                                        <input type="hidden" name="status" value="draft">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="bi bi-arrow-left me-2"></i>Back to Draft
                                                        </button>
                                                    </form>
                                                </li>
                                                {% endif %}
                                                
                                                {% if game.status == 'released' %}
                                                <li>
                                                    <form method="POST" action="{{ url_for('game.change_game_status', game_id=game.id) }}" class="d-inline">
                                                        <input type="hidden" name="status" value="completed">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="bi bi-check-all me-2"></i>Mark Complete
                                                        </button>
                                                    </form>
                                                </li>
                                                {% endif %}
                                                
                                                {% if game.status in ['draft', 'ready', 'released'] %}
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <form method="POST" action="{{ url_for('game.change_game_status', game_id=game.id) }}" class="d-inline">
                                                        <input type="hidden" name="status" value="cancelled">
                                                        <button type="submit" class="dropdown-item text-danger"
                                                                onclick="return confirm('Cancel this game?')">
                                                            <i class="bi bi-x-circle me-2"></i>Cancel Game
                                                        </button>
                                                    </form>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if games.pages > 1 %}
                <nav aria-label="Game pagination">
                    <ul class="pagination justify-content-center">
                        {% if games.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('game.manage_games', 
                                page=games.prev_num, 
                                search=search, 
                                league=league_filter, 
                                status=status_filter, 
                                date=date_filter) }}">Previous</a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in games.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != games.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('game.manage_games', 
                                        page=page_num, 
                                        search=search, 
                                        league=league_filter, 
                                        status=status_filter, 
                                        date=date_filter) }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if games.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('game.manage_games', 
                                page=games.next_num, 
                                search=search, 
                                league=league_filter, 
                                status=status_filter, 
                                date=date_filter) }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-calendar-x display-1 text-muted"></i>
                    <h4 class="mt-3">No games found</h4>
                    <p class="text-muted">Try adjusting your search criteria or add a new game.</p>
                    <a href="{{ url_for('game.add_game') }}" class="btn btn-primary">Add First Game</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}