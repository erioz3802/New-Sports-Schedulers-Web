{% extends "base.html" %}

{% block title %}League Assignments - Sports Scheduler{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-users-cog text-primary me-2"></i>League Assignments
                    </h2>
                    <p class="text-muted mb-0">Assign leagues to administrators and manage permissions</p>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-info me-2">{{ administrators|length }} Administrators</span>
                    <span class="badge bg-success">{{ leagues|length }} Leagues</span>
                </div>
            </div>

            <!-- Assignment Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-1">{{ assignment_stats.total_assignments or 0 }}</h3>
                            <p class="mb-0 small">Total Assignments</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-1">{{ assignment_stats.active_admins or 0 }}</h3>
                            <p class="mb-0 small">Active Admins</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-1">{{ assignment_stats.unassigned_leagues or 0 }}</h3>
                            <p class="mb-0 small">Unassigned Leagues</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-1">{{ assignment_stats.avg_assignments or 0 }}</h3>
                            <p class="mb-0 small">Avg per Admin</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignment Management Table -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Administrator League Assignments
                        </h5>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#assignLeagueModal">
                            <i class="fas fa-plus me-1"></i>Assign League
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if administrators %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th><i class="fas fa-user me-1"></i>Administrator</th>
                                        <th><i class="fas fa-envelope me-1"></i>Email</th>
                                        <th><i class="fas fa-trophy me-1"></i>Assigned Leagues</th>
                                        <th><i class="fas fa-chart-line me-1"></i>Permission Levels</th>
                                        <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for admin in administrators %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                                    {{ admin.full_name[0].upper() }}
                                                </div>
                                                <div>
                                                    <strong>{{ admin.full_name }}</strong>
                                                    <br><small class="text-muted">{{ admin.role|title }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <i class="fas fa-envelope text-muted me-1"></i>
                                            {{ admin.email }}
                                        </td>
                                        <td>
                                            {% if admin.assigned_leagues %}
                                                {% for league in admin.assigned_leagues %}
                                                    {% if league.source == 'created' %}
                                                        <span class="badge bg-primary me-1 mb-1" title="League created by this admin">
                                                            {{ league.name }} ({{ league.level }}) - OWNER
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-success me-1 mb-1" title="League assigned by superadmin">
                                                            {{ league.name }} ({{ league.level }})
                                                        </span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-muted"><i>No leagues assigned</i></span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if admin.assigned_leagues %}
                                                {% for league in admin.assigned_leagues %}
                                                    <span class="badge bg-info me-1 mb-1">{{ league.permission_level|title }}</span>
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        onclick="assignLeague({{ admin.id }}, '{{ admin.full_name }}')"
                                                        title="Assign League">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                {% if admin.assigned_leagues %}
                                                <button type="button" class="btn btn-sm btn-outline-warning" 
                                                        onclick="manageAssignments({{ admin.id }}, '{{ admin.full_name }}')"
                                                        title="Manage Assignments">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5>No Administrators Found</h5>
                            <p class="text-muted">No administrators are available for league assignment.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign League Modal -->
<div class="modal fade" id="assignLeagueModal" tabindex="-1" aria-labelledby="assignLeagueModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.assign_league_to_admin') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignLeagueModalLabel">
                        <i class="fas fa-trophy text-primary me-2"></i>Assign League to Administrator
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="admin_id" class="form-label">
                            <i class="fas fa-user me-1"></i>Select Administrator
                        </label>
                        <select class="form-select" id="admin_id" name="admin_id" required>
                            <option value="">Choose administrator...</option>
                            {% for admin in administrators %}
                            <option value="{{ admin.id }}">{{ admin.full_name }} ({{ admin.email }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="league_id" class="form-label">
                            <i class="fas fa-trophy me-1"></i>Select League
                        </label>
                        <select class="form-select" id="league_id" name="league_id" required>
                            <option value="">Choose league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }} - {{ league.level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="permission_level" class="form-label">
                            <i class="fas fa-shield-alt me-1"></i>Permission Level
                        </label>
                        <select class="form-select" id="permission_level" name="permission_level" required>
                            <option value="admin">Administrator - Full league management</option>
                            <option value="assigner">Assigner - Can assign officials only</option>
                            <option value="viewer">Viewer - Read-only access</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Permission Levels:</strong><br>
                        <small>
                            <strong>Administrator:</strong> Full control over league settings, games, and assignments<br>
                            <strong>Assigner:</strong> Can manage games and assign officials<br>
                            <strong>Viewer:</strong> Read-only access to league data and reports
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-1"></i>Assign League
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manage Assignments Modal -->
<div class="modal fade" id="manageAssignmentsModal" tabindex="-1" aria-labelledby="manageAssignmentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageAssignmentsModalLabel">
                    <i class="fas fa-cogs text-warning me-2"></i>Manage League Assignments
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="assignmentsList">
                    <!-- Dynamic content loaded by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript for dynamic modal management
function assignLeague(adminId, adminName) {
    // Pre-select the administrator in the modal
    document.getElementById('admin_id').value = adminId;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('assignLeagueModal'));
    modal.show();
}

function manageAssignments(adminId, adminName) {
    // Update modal title
    document.getElementById('manageAssignmentsModalLabel').innerHTML = 
        '<i class="fas fa-cogs text-warning me-2"></i>Manage Assignments for ' + adminName;
    
    // Load current assignments via AJAX
    fetch(`/admin/api/admin-assignments/${adminId}`)
        .then(response => response.json())
        .then(data => {
            let html = '';
            if (data.assignments && data.assignments.length > 0) {
                html = '<div class="table-responsive"><table class="table table-sm">';
                html += '<thead><tr><th>League</th><th>Permission</th><th>Assigned Date</th><th>Action</th></tr></thead><tbody>';
                
                data.assignments.forEach(assignment => {
                    html += `<tr>
                        <td><strong>${assignment.league_name}</strong> (${assignment.league_level})</td>
                        <td><span class="badge bg-info">${assignment.permission_level}</span></td>
                        <td>${assignment.assigned_date}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="removeAssignment(${assignment.membership_id})">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            } else {
                html = '<div class="text-center py-3"><p class="text-muted">No league assignments found.</p></div>';
            }
            
            document.getElementById('assignmentsList').innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading assignments:', error);
            document.getElementById('assignmentsList').innerHTML = 
                '<div class="alert alert-danger">Error loading assignments. Please try again.</div>';
        });
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('manageAssignmentsModal'));
    modal.show();
}

function removeAssignment(membershipId) {
    if (confirm('Are you sure you want to remove this league assignment?')) {
        fetch('/admin/remove-league-assignment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({membership_id: membershipId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh the page to show updated data
            } else {
                alert('Error removing assignment: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing assignment. Please try again.');
        });
    }
}
</script>

<style>
.avatar-sm {
    width: 35px;
    height: 35px;
    font-size: 14px;
    font-weight: bold;
    color: white;
}

.badge {
    font-size: 0.75em;
}

.card-body .table th {
    border-top: none;
}

.btn-group .btn {
    margin-right: 2px;
}
</style>
{% endblock %}