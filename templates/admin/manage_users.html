{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">User Management</h1>
                    {% if current_user.role != 'superadmin' %}
                    <div class="modal fade" id="addFromMasterModal" tabindex="-1" aria-labelledby="addFromMasterModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="addFromMasterModalLabel">
                                        <i class="fas fa-user-plus"></i> Add Users from Master List
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Search Box -->
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="masterUserSearch" placeholder="Search users by name or email...">
                                        </div>
                                    </div>
                
                                    <!-- Loading Indicator -->
                                    <div id="masterUserLoading" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading available users...</p>
                                    </div>
                
                                    <!-- User List -->
                                    <div id="masterUserList" class="d-none">
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                            <table class="table table-hover">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th>Select</th>
                                                        <th>Name</th>
                                                        <th>Email</th>
                                                        <th>Role</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="masterUserTableBody">
                                                    <!-- Users will be populated here via JavaScript -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                
                                    <!-- No Results Message -->
                                    <div id="noMasterUsers" class="text-center py-4 d-none">
                                        <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                                        <h5>No Available Users</h5>
                                        <p class="text-muted">All users are already in your local list or no users match your search.</p>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" id="addSelectedUsers" class="btn btn-primary" disabled>
                                        <i class="fas fa-plus"></i> Add Selected Users
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('admin.add_user') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New User
                    </a>
                    {% if current_user.role != 'superadmin' %}
                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addFromMasterModal">
                            <i class="fas fa-user-plus"></i> Add from Master List
                        </button>
                    {% endif %}
                    {% if current_user.role == 'superadmin' %}
                        <a href="{{ url_for('admin.api_master_users') }}" class="btn btn-info">
                            <i class="fas fa-list"></i> Master User List
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Statistics Cards (for superadmin) -->
            {% if current_user.role == 'superadmin' and master_stats %}
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ master_stats.total_users }}</h4>
                                    <p class="mb-0">Total Users</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ master_stats.active_users }}</h4>
                                    <p class="mb-0">Active Users</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-user-check fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ master_stats.by_role.get('administrator', 0) }}</h4>
                                    <p class="mb-0">Administrators</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-user-cog fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ master_stats.by_role.get('official', 0) }}</h4>
                                    <p class="mb-0">Officials</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-whistle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Search and Filter Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search Users</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search }}" placeholder="Name or email...">
                        </div>
                        <div class="col-md-3">
                            <label for="role" class="form-label">Filter by Role</label>
                            <select class="form-select" id="role" name="role">
                                <option value="">All Roles</option>
                                <option value="superadmin" {% if role_filter == 'superadmin' %}selected{% endif %}>Superadmin</option>
                                <option value="administrator" {% if role_filter == 'administrator' %}selected{% endif %}>Administrator</option>
                                <option value="assigner" {% if role_filter == 'assigner' %}selected{% endif %}>Assigner</option>
                                <option value="official" {% if role_filter == 'official' %}selected{% endif %}>Official</option>
                                <option value="viewer" {% if role_filter == 'viewer' %}selected{% endif %}>Viewer</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Filter by Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Status</option>
                                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Filter</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        {% if current_user.role == 'superadmin' %}
                            All Users ({{ users|length }})
                        {% else %}
                            Your Local Users ({{ users|length }})
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if users %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th width="200">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar me-2">
                                                <span class="avatar-initial rounded-circle bg-primary text-white">
                                                    {{ user.first_name[0] }}{{ user.last_name[0] }}
                                                </span>
                                            </div>
                                            <strong>{{ user.first_name }} {{ user.last_name }}</strong>
                                        </div>
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.phone or '-' }}</td>
                                    <td>
                                        <span class="badge bg-{% if user.role == 'superadmin' %}danger{% elif user.role == 'administrator' %}primary{% elif user.role == 'assigner' %}info{% elif user.role == 'official' %}success{% else %}secondary{% endif %}">
                                            {{ user.role.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" 
                                               class="btn btn-outline-primary" title="Edit User">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% if current_user.role == 'superadmin' or current_user.role != 'superadmin' %}
                                            <button class="btn btn-outline-danger" 
                                                    onclick="confirmDelete({{ user.id }}, '{{ user.first_name }} {{ user.last_name }}')" 
                                                    title="{% if current_user.role == 'superadmin' %}Deactivate User{% else %}Remove from Local List{% endif %}">
                                                <i class="fas fa-{% if current_user.role == 'superadmin' %}user-slash{% else %}user-minus{% endif %}"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5>No Users Found</h5>
                        {% if current_user.role != 'superadmin' %}
                            <p class="text-muted">Add users from the master list to get started.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFromMasterModal">
                                <i class="fas fa-user-plus"></i> Add from Master List
                            </button>
                        {% else %}
                            <p class="text-muted">Create your first user to get started.</p>
                            <a href="{{ url_for('admin.add_user') }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add New User
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add from Master List Modal (for non-superadmin users) -->
{% if current_user.role != 'superadmin' %}
<div class="modal fade" id="addFromMasterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add User from Master List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="masterUsersList">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading master user list...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if current_user.role == 'superadmin' %}
                        Deactivate User
                    {% else %}
                        Remove User from Local List
                    {% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>
                    {% if current_user.role == 'superadmin' %}
                        Are you sure you want to deactivate <strong id="deleteUserName"></strong>?
                        This will deactivate the user from the entire system.
                    {% else %}
                        Are you sure you want to remove <strong id="deleteUserName"></strong> from your local list?
                        This will only remove them from your list, not the master system.
                    {% endif %}
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        {% if current_user.role == 'superadmin' %}
                            Deactivate User
                        {% else %}
                            Remove from List
                        {% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Delete confirmation
function confirmDelete(userId, userName) {
    document.getElementById('deleteUserName').textContent = userName;
    document.getElementById('deleteForm').action = `/admin/users/${userId}/delete`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// Load master users list for modal (non-superadmin only)
{% if current_user.role != 'superadmin' %}
document.addEventListener('DOMContentLoaded', function() {
    const addFromMasterModal = document.getElementById('addFromMasterModal');
    const masterUserSearch = document.getElementById('masterUserSearch');
    const masterUserLoading = document.getElementById('masterUserLoading');
    const masterUserList = document.getElementById('masterUserList');
    const noMasterUsers = document.getElementById('noMasterUsers');
    const masterUserTableBody = document.getElementById('masterUserTableBody');
    const addSelectedButton = document.getElementById('addSelectedUsers');
    
    let allMasterUsers = [];
    let filteredUsers = [];
    
    // Load master users when modal opens
    if (addFromMasterModal) {
        addFromMasterModal.addEventListener('show.bs.modal', function() {
            loadMasterUsers();
        });
    }
    
    // Search functionality
    if (masterUserSearch) {
        masterUserSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            filterUsers(searchTerm);
        });
    }
    
    // Add selected users functionality
    if (addSelectedButton) {
        addSelectedButton.addEventListener('click', function() {
            const selectedUsers = document.querySelectorAll('input[name="selectedUsers"]:checked');
            if (selectedUsers.length === 0) {
                alert('Please select at least one user.');
                return;
            }
        
            // Create form with ALL selected users at once
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("admin.add_user_from_master") }}';
            form.style.display = 'none';
        
            // Add ALL selected user IDs to the same form
            selectedUsers.forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'user_id';  // Same name for all - Flask will collect as list
                input.value = checkbox.value;
                form.appendChild(input);
            });
        
            // Add CSRF token if you're using it
            const csrfToken = document.querySelector('meta[name=csrf-token]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }
        
            // Submit the form with all users
            document.body.appendChild(form);
            form.submit();
        });
    }
    
    function loadMasterUsers() {
        // Show loading
        masterUserLoading.classList.remove('d-none');
        masterUserList.classList.add('d-none');
        noMasterUsers.classList.add('d-none');
        
        // Reset search
        if (masterUserSearch) {
            masterUserSearch.value = '';
        }
        
        // Fetch master users
        fetch('{{ url_for("admin.api_master_users") }}')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                allMasterUsers = data.users || data;
                
                // Filter out users already in local list
                const currentUserIds = {{ (users | map(attribute='id') | list) | tojson }};
                filteredUsers = allMasterUsers.filter(user => 
                    !currentUserIds.includes(user.id)
                );
                
                displayUsers(filteredUsers);
            })
            .catch(error => {
                console.error('Error loading master users:', error);
                masterUserLoading.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading users: ${error.message}
                    </div>
                `;
            });
    }
    
    function filterUsers(searchTerm) {
        if (!searchTerm) {
            displayUsers(filteredUsers);
            return;
        }
        
        const filtered = filteredUsers.filter(user => {
            const fullName = `${user.first_name} ${user.last_name}`.toLowerCase();
            const email = user.email.toLowerCase();
            return fullName.includes(searchTerm) || email.includes(searchTerm);
        });
        
        displayUsers(filtered);
    }
    
    function displayUsers(users) {
        masterUserLoading.classList.add('d-none');
        
        if (users.length === 0) {
            masterUserList.classList.add('d-none');
            noMasterUsers.classList.remove('d-none');
            updateAddButton();
            return;
        }
        
        noMasterUsers.classList.add('d-none');
        masterUserList.classList.remove('d-none');
        
        // Build table rows
        masterUserTableBody.innerHTML = users.map(user => `
            <tr>
                <td>
                    <div class="form-check">
                        <input class="form-check-input user-checkbox" type="checkbox" 
                               name="selectedUsers" value="${user.id}" id="user_${user.id}"
                               onchange="updateAddButton()">
                        <label class="form-check-label" for="user_${user.id}"></label>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar me-2">
                            <span class="avatar-initial rounded-circle bg-primary text-white">
                                ${user.first_name[0]}${user.last_name[0]}
                            </span>
                        </div>
                        <strong>${user.first_name} ${user.last_name}</strong>
                    </div>
                </td>
                <td>${user.email}</td>
                <td>
                    <span class="badge bg-${getRoleBadgeColor(user.role)}">
                        ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                    </span>
                </td>
            </tr>
        `).join('');
        
        updateAddButton();
    }
    
    function getRoleBadgeColor(role) {
        const colors = {
            'superadmin': 'danger',
            'administrator': 'primary',
            'assigner': 'info',
            'official': 'success',
            'viewer': 'secondary'
        };
        return colors[role] || 'secondary';
    }
    
    // Update add button state
    window.updateAddButton = function() {
        const checkedBoxes = document.querySelectorAll('input[name="selectedUsers"]:checked');
        if (addSelectedButton) {
            addSelectedButton.disabled = checkedBoxes.length === 0;
            
            if (checkedBoxes.length > 0) {
                addSelectedButton.innerHTML = `<i class="fas fa-plus"></i> Add ${checkedBoxes.length} User${checkedBoxes.length > 1 ? 's' : ''}`;
            } else {
                addSelectedButton.innerHTML = '<i class="fas fa-plus"></i> Add Selected Users';
            }
        }
    };
});
{% endif %}
</script>

<style>
.avatar {
    width: 40px;
    height: 40px;
}

.avatar-initial {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
}
</style>
{% endblock %}